# .github/workflows/terraform.yml
name: Terraform CI/CD
 
on:
  workflow_dispatch:
  push:
    branches: [ main ]
 
env:
  TF_CLI_ARGS: "-no-color"

permissions:
  id-token: write # This is required for requesting the JWT token from GitHub IdP
  contents: read # This is required for actions/checkout
  pull-requests: write # This is required for gh bot to comment PR
  actions: read
  checks: write
  issues: write # Ensure this is added

jobs:
  terraform-plan:
    name: Terraform Init & Plan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
 
      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-Terraform
          aws-region: ${{ secrets.AWS_REGION }}
 
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
      
      - name: Terraform Init
        #run: terraform init
        run: terraform init -backend=false
      
      
      - name: Terraform Plan
        run: terraform plan -out=tfplan
 
      - name: Upload plan artifact
        uses: actions/upload-artifact@v4
        with:
          name: tfplan
          path: tfplan
 
  approval-and-apply:
    name: Approval ‚Üí Terraform Apply
    runs-on: ubuntu-latest
    needs: terraform-plan
    # üëá This is the ‚Äúgate‚Äù that will pause until approved
    environment: dev
    steps:
      - name: Checkout
        uses: actions/checkout@v4
 
      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-Terraform
          aws-region: ${{ secrets.AWS_REGION }}
 
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
 
      - name: Download plan artifact
        uses: actions/download-artifact@v4
        with:
          name: tfplan
 
      - name: Terraform Apply
        run: terraform apply -auto-approve tfplan
 